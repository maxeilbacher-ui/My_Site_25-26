<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Max Eilbacher</title>
    <script src="lib/main.js" type="text/javascript" type="module"></script>
    <script type='text/javascript'>
      var boot = function() {
        if (!Module || !Module.arguments) {
          console.log("Module not ready yet");
          return;
        }
        document.getElementById('boot').disabled = true;
        var args = Module['arguments'];
        Module.callMain(args);
        // setTimeout(runScalaCollider, 100);
        runScalaCollider();
        
        window.example = example;
        window.cmdPeriod = cmdPeriod;
      }
      
      // Listen for any interaction on the page
      document.addEventListener('click', function() {
        // Check if Module is ready
        if (!Module || !Module.arguments) {
          console.log("Module not ready for interaction");
          return;
        }
        
        // If boot button is enabled, trigger boot
        var bootBtn = document.getElementById('boot');
        if (!bootBtn.disabled) {
          boot();
        }
      }, true);

    </script>

    <style>
      #supercollider {
        font-size: 10px;
        width: 0;
        height: 0;
        overflow: hidden;
        position: fixed;
        bottom: 0;
        right: 100vw;
        z-index: 999;
        opacity: 0;
        
      }

      .emscripten {
        padding-right: 0;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
      div.emscripten {
        text-align: center;
      }
      div.emscripten_border {
        border: 1px solid black;
      }

      #boot {
        font-size: 20px;
        margin-left: 20px;
        margin-bottom: 10px;
      }

      @-webkit-keyframes rotation {
        from {
          -webkit-transform: rotate(0deg);
        }
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-moz-keyframes rotation {
        from {
          -moz-transform: rotate(0deg);
        }
        to {
          -moz-transform: rotate(360deg);
        }
      }
      @-o-keyframes rotation {
        from {
          -o-transform: rotate(0deg);
        }
        to {
          -o-transform: rotate(360deg);
        }
      }
      @keyframes rotation {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      #status {
        display: inline-block;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 20px;
        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      #progress {
        height: 20px;
        width: 300px;
      }

      #controls {
        float: left;
        vertical-align: top;
        margin-top: 30px;
        margin-right: 20px;
      }

      #output {
        width: 100%;
        height: 300px;
        margin: 0 auto;
        margin-top: 10px;
        border-left: 0px;
        border-right: 0px;
        padding-left: 0px;
        padding-right: 0px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    
    <script type="module" src="/src/main.js"></script>

    <div id="supercollider">
      <div class="emscripten" id="status">Downloading...</div>

      <span id="controls">
        <input type="button" id="boot" disabled="disabled" value="Boot" onclick="boot();" />
        <input type="button" id="bubbles" value="Bubbles" onclick="example('bubbles');" />
        <input type="button" id="stop" value="Stop" onclick="cmdPeriod();" />
        <!-- Inputs:
        <input type="number" id="num-inputs" value="0" min="0" max="2" step="1" />
        Outputs:
        <input type="number" id="num-outputs" value="2" min="0" max="2" step="1" /> -->
      </span>

      <div class="emscripten">
        <progress value="0" max="100" id="progress" hidden="1"></progress>
      </div>

      <textarea id="output" rows="8"></textarea>

      <script type="text/javascript">
        var statusElement = document.getElementById('status')
        var progressElement = document.getElementById('progress')
        var bootElement = document.getElementById('boot')

        var Module = {
          preRun: [],
          postRun: [],
          print: (function () {
            var element = document.getElementById('output')
            if (element) element.value = '' // clear browser cache
            return function (text) {
              if (arguments.length > 1)
                text = Array.prototype.slice.call(arguments).join(' ')
              // These replacements are necessary if you render to raw HTML
              //text = text.replace(/&/g, "&amp;");
              //text = text.replace(/</g, "&lt;");
              //text = text.replace(/>/g, "&gt;");
              //text = text.replace('\n', '<br>', 'g');
              console.log(text)
              if (element) {
                element.value += text + '\n'
                element.scrollTop = element.scrollHeight // focus on bottom
              }
            }
          })(),
          printErr: function (text) {
            if (arguments.length > 1)
              text = Array.prototype.slice.call(arguments).join(' ')
            console.error(text)
          },
          setStatus: function (text) {
            if (!Module.setStatus.last)
              Module.setStatus.last = { time: Date.now(), text: '' }
            if (text === Module.setStatus.last.text) return
            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/)
            var now = Date.now()
            if (m && now - Module.setStatus.last.time < 30) return // if this is a progress update, skip it if too soon
            Module.setStatus.last.time = now
            Module.setStatus.last.text = text
            if (m) {
              text = m[1]
              progressElement.value = parseInt(m[2]) * 100
              progressElement.max = parseInt(m[4]) * 100
              progressElement.hidden = false
            } else {
              progressElement.value = null
              progressElement.max = null
              progressElement.hidden = true
            }
            statusElement.innerHTML = text
          },
          totalDependencies: 0,
          monitorRunDependencies: function (left) {
            this.totalDependencies = Math.max(this.totalDependencies, left)
            Module.setStatus(
              left
                ? 'Preparing... (' +
                    (this.totalDependencies - left) +
                    '/' +
                    this.totalDependencies +
                    ')'
                : 'All downloads complete.'
            )
          },
          onRuntimeInitialized: function () {
            bootElement.disabled = false
          }
        }
        Module.setStatus('Downloading...')
        window.onerror = function (event) {
          // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
          Module.setStatus('Exception thrown, see JavaScript console')
          Module.setStatus = function (text) {
            if (text) Module.printErr('[post-exception status] ' + text)
          }
        }
      </script>
      <script async type="text/javascript" src="lib/scsynth.js" type="module"></script>
    </div>
  </body>
</html>
